{
    "$schema": "./aws-deploy-recipe-schema.json",
    "Id": "AspNetAppEcsFargate",
    "Version": "0.1.0",
    "Name": "ASP.NET Core App to Amazon ECS using Fargate",
    "DeploymentType": "CdkProject",
    "DeploymentBundle": "Container",
    "CdkProjectTemplate": "../CdkTemplates/AspNetAppEcsFargate",
    "CdkProjectTemplateId": "netdeploy.AspNetAppEcsFargate",
    "Description": "ASP.NET Core applications built as a container and deployed to Amazon Elastic Container Service (ECS) with compute power managed by AWS Fargate compute engine. Recommended for applications that can be deployed as a container image. If your project does not contain a Dockerfile, one will be generated for the project.",
    "TargetService": "Amazon Elastic Container Service",

    "RecipePriority": 110,
    "RecommendationRules": [
        {
            "Tests": [
                {
                    "Type": "MSProjectSdkAttribute",
                    "Condition": {
                        "Value": "Microsoft.NET.Sdk.Web"
                    }
                },
                {
                    "Type": "MSProperty",
                    "Condition": {
                        "PropertyName": "TargetFramework",
                        "AllowedValues": [ "netcoreapp2.1", "netcoreapp3.1", "net5.0" ]
                    }
                }
            ]
        },

        {
            "Tests": [
                {
                    "Type": "FileExists",
                    "Condition": {
                        "FileName": "Dockerfile"
                    }
                }
            ],
            "Effect": {
                "Fail": {
                    "PriorityAdjustment": -55,
                    "Include": true
                }
            }
        },


        {
            "Tests": [
                {
                    "Type": "MSPropertyExists",
                    "Condition": {
                        "PropertyName": "AWSProjectType"
                    }
                }
            ],
            "Effect": {
                "Pass": { "Include": false },
                "Fail": { "Include": true }
            }
        }

    ],



    "OptionSettings": [
        {
            "Id": "ECSCluster",
            "Name": "ECS Cluster",
            "Description": "The ECS cluster used for the deployment.",
            "Type": "Object",
            "TypeHint": "ECSCluster",
            "AdvancedSetting": false,
            "Updatable": false,
            "ChildOptionSettings": [
                {
                    "Id": "CreateNew",
                    "Name": "Create New ECS Cluster",
                    "Description": "Do you want to create a new ECS Cluster?",
                    "Type": "Bool",
                    "DefaultValue": true,
                    "AdvancedSetting": false,
                    "Updatable": false
                },
                {
                    "Id": "ClusterArn",
                    "Name": "Existing Cluster Arn",
                    "Description": "The Arn of the existing cluster to use.",
                    "Type": "String",
                    "AdvancedSetting": false,
                    "Updatable": false,
                    "DependsOn": [
                        {
                            "Id": "ECSCluster.CreateNew",
                            "Value": false
                        }
                    ]
                },
                {
                    "Id": "NewClusterName",
                    "Name": "New Cluster Name",
                    "Description": "The name of the new cluster to create.",
                    "Type": "String",
                    "DefaultValue": "{ProjectName}",
                    "AdvancedSetting": false,
                    "Updatable": false,
                    "DependsOn": [
                        {
                            "Id": "ECSCluster.CreateNew",
                            "Value": true
                        }
                    ]
                }
            ]
        },
        {
            "Id": "ECSServiceName",
            "ParentSettingId": "ClusterName",
            "Name": "ECS Service Name",
            "Description": "The name of the ECS service running in the cluster.",
            "Type": "String",
            "TypeHint": "ECSService",
            "DefaultValue": "{ProjectName}-service",
            "AdvancedSetting": false,
            "Updatable": false
        },
        {
            "Id": "DesiredCount",
            "Name": "Desired Task Count",
            "Description": "The desired number of Amazon ECS tasks to run for the service.",
            "Type": "Int",
            "DefaultValue": 3,
            "AdvancedSetting": false,
            "Updatable": true
        },
        {
            "Id": "ApplicationIAMRole",
            "Name": "Application IAM Role",
            "Description": "The Identity and Access Management Role that provides AWS credentials to the application to access AWS services",
            "Type": "Object",
            "TypeHint": "IAMRole",
            "TypeHintData": {
                "ServicePrincipal": "ecs-tasks.amazonaws.com"
            },
            "AdvancedSetting": false,
            "Updatable": false,
            "ChildOptionSettings": [
                {
                    "Id": "CreateNew",
                    "Name": "Create New Role",
                    "Description": "Do you want to create a new Role?",
                    "Type": "Bool",
                    "DefaultValue": true,
                    "AdvancedSetting": false,
                    "Updatable": false
                },
                {
                    "Id": "RoleArn",
                    "Name": "Existing Role Arn",
                    "Description": "The Arn of the existing role to use.",
                    "Type": "String",
                    "AdvancedSetting": false,
                    "Updatable": false,
                    "DependsOn": [
                        {
                            "Id": "ApplicationIAMRole.CreateNew",
                            "Value": false
                        }
                    ]
                }
            ]
        },
        {
            "Id": "Vpc",
            "Name": "Virtual Private Cloud",
            "Description": "A VPC enables you to launch the application into a virtual network that you've defined",
            "Type": "Object",
            "TypeHint": "Vpc",
            "AdvancedSetting": false,
            "Updatable": false,
            "ChildOptionSettings": [
                {
                    "Id": "IsDefault",
                    "Name": "Use default VPC",
                    "Description": "Do you want to use the default VPC for the deployment?",
                    "Type": "Bool",
                    "DefaultValue": true,
                    "AdvancedSetting": false,
                    "Updatable": false
                },
                {
                    "Id": "CreateNew",
                    "Name": "Create New VPC",
                    "Description": "Do you want to create a new VPC?",
                    "Type": "Bool",
                    "DefaultValue": false,
                    "AdvancedSetting": false,
                    "Updatable": false,
                    "DependsOn": [
                        {
                            "Id": "Vpc.IsDefault",
                            "Value": false
                        }
                    ]
                },
                {
                    "Id": "VpcId",
                    "Name": "Existing VPC Id",
                    "Description": "The Id of the existing VPC to use.",
                    "Type": "String",
                    "DefaultValue": null,
                    "AdvancedSetting": false,
                    "Updatable": false,
                    "DependsOn": [
                        {
                            "Id": "Vpc.IsDefault",
                            "Value": false
                        },
                        {
                            "Id": "Vpc.CreateNew",
                            "Value": false
                        }
                    ]
                }
            ]
        },
        {
            "Id": "AdditionalECSServiceSecurityGroups",
            "Name": "ECS Service Security Groups",
            "Description": "Comma delimited list of EC2 security groups to assign to the ECS service. This is commonly used to provide access to RDS databases running in their own security groups.",
            "Type": "String",
            "DefaultValue": "",
            "AdvancedSetting": true,
            "Updatable": true
        },
        {
            "Id": "TaskCpu",
            "Name": "Task CPU",
            "Description": "The number of CPU units used by the task. See here for more details on CPU values https://docs.aws.amazon.com/AmazonECS/latest/developerguide/AWS_Fargate.html#fargate-task-defs",
            "Type": "Int",
            "DefaultValue": 256,
            "AdvancedSetting": true,
            "Updatable": true
        },
        {
            "Id": "TaskMemory",
            "Name": "Task Memory",
            "Description": "The amount of memory (in MB) used by the task. See here for more details on Memory values https://docs.aws.amazon.com/AmazonECS/latest/developerguide/AWS_Fargate.html#fargate-task-defs",
            "Type": "Int",
            "DefaultValue": 512,
            "AdvancedSetting": true,
            "Updatable": true
        }
    ]
}
